var Et=Object.defineProperty;var It=Object.getPrototypeOf;var bt=Reflect.get;var Me=e=>{throw TypeError(e)};var wt=(e,t,r)=>t in e?Et(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r;var Y=(e,t,r)=>wt(e,typeof t!="symbol"?t+"":t,r),Ee=(e,t,r)=>t.has(e)||Me("Cannot "+r);var u=(e,t,r)=>(Ee(e,t,"read from private field"),r?r.call(e):t.get(e)),A=(e,t,r)=>t.has(e)?Me("Cannot add the same private member more than once"):t instanceof WeakSet?t.add(e):t.set(e,r),K=(e,t,r,s)=>(Ee(e,t,"write to private field"),s?s.call(e,r):t.set(e,r),r),de=(e,t,r)=>(Ee(e,t,"access private method"),r);var Pe=(e,t,r)=>bt(It(e),r,t);import{t as ke,a as pe,c as vt}from"../chunks/DL4Cwa5e.js";import{i as St}from"../chunks/BjbwdHKA.js";import{V as Ze,ao as Tt,ap as At,I as xt,e as Ct,s as Ie,h as M,J as kt,d as Nt,w as _,a9 as Rt,f as Dt,r as Fe,g as be,k as X,Z as Ot,i as Qe,j as et,p as Mt,aq as we,a1 as tt,L as Le,ar as Pt,ae as rt,as as F,at as Ft,au as Lt,a0 as jt,av as Jt,m as Vt,aw as Bt,ax as Ut,X as Yt,ay as Kt,az as $t,aA as zt,aB as Gt,b as Ne,a4 as qt,ad as R,aC as Ht,aD as Wt,aE as Xt,al as z,ac as Zt,an as $,A as Qt,C as er,D as Z,F as J,G as je,aF as tr,aG as rr,o as sr,B as Je}from"../chunks/Drkbx91g.js";import{a as ar,l as nr,e as or,s as Ve}from"../chunks/9HmzWm-j.js";import{i as ir}from"../chunks/CA3MNjiG.js";const lr=[];function Be(e,t=!1){return he(e,new Map,"",lr)}function he(e,t,r,s,a=null){if(typeof e=="object"&&e!==null){var c=t.get(e);if(c!==void 0)return c;if(e instanceof Map)return new Map(e);if(e instanceof Set)return new Set(e);if(Ze(e)){var f=Array(e.length);t.set(e,f),a!==null&&t.set(a,f);for(var i=0;i<e.length;i+=1){var o=e[i];i in e&&(f[i]=he(o,t,r,s))}return f}if(Tt(e)===At){f={},t.set(e,f),a!==null&&t.set(a,f);for(var n in e)f[n]=he(e[n],t,r,s);return f}if(e instanceof Date)return structuredClone(e);if(typeof e.toJSON=="function")return he(e.toJSON(),t,r,s,e)}if(e instanceof EventTarget)return e;try{return structuredClone(e)}catch{return e}}function Ue(e,t){return t}function cr(e,t,r,s){for(var a=[],c=t.length,f=0;f<c;f++)Lt(t[f].e,a,!0);var i=c>0&&a.length===0&&r!==null;if(i){var o=r.parentNode;jt(o),o.append(r),s.clear(),L(e,t[0].prev,t[c-1].next)}Jt(a,()=>{for(var n=0;n<c;n++){var l=t[n];i||(s.delete(l.k),L(e,l.prev,l.next)),Vt(l.e,!i)}})}function Ye(e,t,r,s,a,c=null){var f=e,i={flags:t,items:new Map,first:null};{var o=e;f=M?Ie(kt(o)):o.appendChild(xt())}M&&Nt();var n=null,l=!1,d=Rt(()=>{var h=r();return Ze(h)?h:h==null?[]:tt(h)});Ct(()=>{var h=_(d),g=h.length;if(l&&g===0)return;l=g===0;let m=!1;if(M){var b=f.data===Dt;b!==(g===0)&&(f=Fe(),Ie(f),be(!1),m=!0)}if(M){for(var S=null,y,v=0;v<g;v++){if(X.nodeType===8&&X.data===Ot){f=X,m=!0,be(!1);break}var k=h[v],N=s(k,v);y=st(X,i,S,null,k,N,v,a,t,r),i.items.set(N,y),S=y}g>0&&Ie(Fe())}M||ur(h,i,f,a,t,s,r),c!==null&&(g===0?n?Qe(n):n=et(()=>c(f)):n!==null&&Mt(n,()=>{n=null})),m&&be(!0),_(d)}),M&&(f=X)}function ur(e,t,r,s,a,c,f){var i=e.length,o=t.items,n=t.first,l=n,d,h=null,g=[],m=[],b,S,y,v;for(v=0;v<i;v+=1){if(b=e[v],S=c(b,v),y=o.get(S),y===void 0){var k=l?l.e.nodes_start:r;h=st(k,t,h,h===null?t.first:h.next,b,S,v,s,a,f),o.set(S,h),g=[],m=[],l=h.next;continue}if(fr(y,b,v),(y.e.f&we)!==0&&Qe(y.e),y!==l){if(d!==void 0&&d.has(y)){if(g.length<m.length){var N=m[0],w;h=N.prev;var p=g[0],E=g[g.length-1];for(w=0;w<g.length;w+=1)Ke(g[w],N,r);for(w=0;w<m.length;w+=1)d.delete(m[w]);L(t,p.prev,E.next),L(t,h,p),L(t,E,N),l=N,h=E,v-=1,g=[],m=[]}else d.delete(y),Ke(y,l,r),L(t,y.prev,y.next),L(t,y,h===null?t.first:h.next),L(t,h,y),h=y;continue}for(g=[],m=[];l!==null&&l.k!==S;)(l.e.f&we)===0&&(d??(d=new Set)).add(l),m.push(l),l=l.next;if(l===null)continue;y=l}g.push(y),h=y,l=y.next}if(l!==null||d!==void 0){for(var T=d===void 0?[]:tt(d);l!==null;)(l.e.f&we)===0&&T.push(l),l=l.next;var I=T.length;if(I>0){var W=i===0?r:null;cr(t,T,W,o)}}Le.first=t.first&&t.first.e,Le.last=h&&h.e}function fr(e,t,r,s){Pt(e.v,t),e.i=r}function st(e,t,r,s,a,c,f,i,o,n){var l=(o&Bt)!==0,d=(o&Ut)===0,h=l?d?rt(a):F(a):a,g=(o&Ft)===0?f:F(f),m={i:g,v:h,k:c,a:null,e:null,prev:r,next:s};try{return m.e=et(()=>i(e,h,g,n),M),m.e.prev=r&&r.e,m.e.next=s&&s.e,r===null?t.first=m:(r.next=m,r.e.next=m.e),s!==null&&(s.prev=m,s.e.prev=m.e),m}finally{}}function Ke(e,t,r){for(var s=e.next?e.next.e.nodes_start:r,a=t?t.e.nodes_start:r,c=e.e.nodes_start;c!==s;){var f=Yt(c);a.before(c),c=f}}function L(e,t,r){t===null?e.first=r:(t.next=r,t.e.next=r&&r.e),r!==null&&(r.prev=t,r.e.prev=t&&t.e)}const dr=Symbol("is custom element"),pr=Symbol("is html");function hr(e){if(M){var t=!1,r=()=>{if(!t){if(t=!0,e.hasAttribute("value")){var s=e.value;$e(e,"value",null),e.value=s}if(e.hasAttribute("checked")){var a=e.checked;$e(e,"checked",null),e.checked=a}}};e.__on_r=r,Kt(r),ar()}}function $e(e,t,r,s){var a=gr(e);M&&(a[t]=e.getAttribute(t),t==="src"||t==="srcset"||t==="href"&&e.nodeName==="LINK")||a[t]!==(a[t]=r)&&(t==="loading"&&(e[$t]=r),e.removeAttribute(t))}function gr(e){return e.__attributes??(e.__attributes={[dr]:e.nodeName.includes("-"),[pr]:e.namespaceURI===zt})}function _r(e,t,r=t){var s=Gt();nr(e,"input",a=>{var c=a?e.defaultValue:e.value;if(c=ve(e)?Se(c):c,r(c),s&&c!==(c=t())){var f=e.selectionStart,i=e.selectionEnd;e.value=c??"",i!==null&&(e.selectionStart=f,e.selectionEnd=Math.min(i,e.value.length))}}),(M&&e.defaultValue!==e.value||Ne(t)==null&&e.value)&&r(ve(e)?Se(e.value):e.value),qt(()=>{var a=t();ve(e)&&a===Se(e.value)||e.type==="date"&&!a&&!e.value||a!==e.value&&(e.value=a??"")})}function ve(e){var t=e.type;return t==="number"||t==="range"}function Se(e){return e===""?null:+e}function Q(e){R(e,e.v+1)}var at="vercel.ai.error",mr=Symbol.for(at),nt,yr=class ot extends Error{constructor({name:t,message:r,cause:s}){super(r),this[nt]=!0,this.name=t,this.cause=s}static isInstance(t){return ot.hasMarker(t,at)}static hasMarker(t,r){const s=Symbol.for(r);return t!=null&&typeof t=="object"&&s in t&&typeof t[s]=="boolean"&&t[s]===!0}};nt=mr;var H=yr;function it(e){return e==null?"unknown error":typeof e=="string"?e:e instanceof Error?e.message:JSON.stringify(e)}var lt="AI_InvalidArgumentError",ct=`vercel.ai.error.${lt}`,Er=Symbol.for(ct),ut,Ir=class extends H{constructor({message:e,cause:t,argument:r}){super({name:lt,message:e,cause:t}),this[ut]=!0,this.argument=r}static isInstance(e){return H.hasMarker(e,ct)}};ut=Er;var ft="AI_JSONParseError",dt=`vercel.ai.error.${ft}`,br=Symbol.for(dt),pt,ze=class extends H{constructor({text:e,cause:t}){super({name:ft,message:`JSON parsing failed: Text: ${e}.
Error message: ${it(t)}`,cause:t}),this[pt]=!0,this.text=e}static isInstance(e){return H.hasMarker(e,dt)}};pt=br;var ht="AI_TypeValidationError",gt=`vercel.ai.error.${ht}`,wr=Symbol.for(gt),_t,vr=class Te extends H{constructor({value:t,cause:r}){super({name:ht,message:`Type validation failed: Value: ${JSON.stringify(t)}.
Error message: ${it(r)}`,cause:r}),this[_t]=!0,this.value=t}static isInstance(t){return H.hasMarker(t,gt)}static wrap({value:t,cause:r}){return Te.isInstance(r)&&r.value===t?r:new Te({value:t,cause:r})}};_t=wr;var Ge=vr;let Sr=(e,t=21)=>(r=t)=>{let s="",a=r|0;for(;a--;)s+=e[Math.random()*e.length|0];return s};function Tr(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}var V={exports:{}},qe;function Ar(){if(qe)return V.exports;qe=1;const e=typeof Buffer<"u",t=/"(?:_|\\u005[Ff])(?:_|\\u005[Ff])(?:p|\\u0070)(?:r|\\u0072)(?:o|\\u006[Ff])(?:t|\\u0074)(?:o|\\u006[Ff])(?:_|\\u005[Ff])(?:_|\\u005[Ff])"\s*:/,r=/"(?:c|\\u0063)(?:o|\\u006[Ff])(?:n|\\u006[Ee])(?:s|\\u0073)(?:t|\\u0074)(?:r|\\u0072)(?:u|\\u0075)(?:c|\\u0063)(?:t|\\u0074)(?:o|\\u006[Ff])(?:r|\\u0072)"\s*:/;function s(i,o,n){n==null&&o!==null&&typeof o=="object"&&(n=o,o=void 0),e&&Buffer.isBuffer(i)&&(i=i.toString()),i&&i.charCodeAt(0)===65279&&(i=i.slice(1));const l=JSON.parse(i,o);if(l===null||typeof l!="object")return l;const d=n&&n.protoAction||"error",h=n&&n.constructorAction||"error";if(d==="ignore"&&h==="ignore")return l;if(d!=="ignore"&&h!=="ignore"){if(t.test(i)===!1&&r.test(i)===!1)return l}else if(d!=="ignore"&&h==="ignore"){if(t.test(i)===!1)return l}else if(r.test(i)===!1)return l;return a(l,{protoAction:d,constructorAction:h,safe:n&&n.safe})}function a(i,{protoAction:o="error",constructorAction:n="error",safe:l}={}){let d=[i];for(;d.length;){const h=d;d=[];for(const g of h){if(o!=="ignore"&&Object.prototype.hasOwnProperty.call(g,"__proto__")){if(l===!0)return null;if(o==="error")throw new SyntaxError("Object contains forbidden prototype property");delete g.__proto__}if(n!=="ignore"&&Object.prototype.hasOwnProperty.call(g,"constructor")&&Object.prototype.hasOwnProperty.call(g.constructor,"prototype")){if(l===!0)return null;if(n==="error")throw new SyntaxError("Object contains forbidden prototype property");delete g.constructor}for(const m in g){const b=g[m];b&&typeof b=="object"&&d.push(b)}}}return i}function c(i,o,n){const l=Error.stackTraceLimit;Error.stackTraceLimit=0;try{return s(i,o,n)}finally{Error.stackTraceLimit=l}}function f(i,o){const n=Error.stackTraceLimit;Error.stackTraceLimit=0;try{return s(i,o,{safe:!0})}catch{return null}finally{Error.stackTraceLimit=n}}return V.exports=c,V.exports.default=c,V.exports.parse=c,V.exports.safeParse=f,V.exports.scan=a,V.exports}var xr=Ar();const Cr=Tr(xr);var kr=({prefix:e,size:t=16,alphabet:r="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz",separator:s="-"}={})=>{const a=Sr(r,t);if(e==null)return a;if(r.includes(s))throw new Ir({argument:"separator",message:`The separator "${s}" must not be part of the alphabet "${r}".`});return c=>`${e}${s}${a(c)}`},Re=kr();function Nr(e){return e instanceof Error&&(e.name==="AbortError"||e.name==="TimeoutError")}var Ae=Symbol.for("vercel.ai.validator");function Rr(e){return{[Ae]:!0,validate:e}}function Dr(e){return typeof e=="object"&&e!==null&&Ae in e&&e[Ae]===!0&&"validate"in e}function Or(e){return Dr(e)?e:Mr(e)}function Mr(e){return Rr(t=>{const r=e.safeParse(t);return r.success?{success:!0,value:r.data}:{success:!1,error:r.error}})}function Pr({value:e,schema:t}){const r=Or(t);try{if(r.validate==null)return{success:!0,value:e};const s=r.validate(e);return s.success?s:{success:!1,error:Ge.wrap({value:e,cause:s.error})}}catch(s){return{success:!1,error:Ge.wrap({value:e,cause:s})}}}function He({text:e,schema:t}){try{const r=Cr.parse(e);if(t==null)return{success:!0,value:r,rawValue:r};const s=Pr({value:r,schema:t});return s.success?{...s,rawValue:r}:s}catch(r){return{success:!1,error:ze.isInstance(r)?r:new ze({text:e,cause:r})}}}new Set("ABCDEFGHIJKLMNOPQRSTUVXYZabcdefghijklmnopqrstuvxyz0123456789");var ee={code:"0",name:"text",parse:e=>{if(typeof e!="string")throw new Error('"text" parts expect a string value.');return{type:"text",value:e}}},te={code:"3",name:"error",parse:e=>{if(typeof e!="string")throw new Error('"error" parts expect a string value.');return{type:"error",value:e}}},re={code:"4",name:"assistant_message",parse:e=>{if(e==null||typeof e!="object"||!("id"in e)||!("role"in e)||!("content"in e)||typeof e.id!="string"||typeof e.role!="string"||e.role!=="assistant"||!Array.isArray(e.content)||!e.content.every(t=>t!=null&&typeof t=="object"&&"type"in t&&t.type==="text"&&"text"in t&&t.text!=null&&typeof t.text=="object"&&"value"in t.text&&typeof t.text.value=="string"))throw new Error('"assistant_message" parts expect an object with an "id", "role", and "content" property.');return{type:"assistant_message",value:e}}},se={code:"5",name:"assistant_control_data",parse:e=>{if(e==null||typeof e!="object"||!("threadId"in e)||!("messageId"in e)||typeof e.threadId!="string"||typeof e.messageId!="string")throw new Error('"assistant_control_data" parts expect an object with a "threadId" and "messageId" property.');return{type:"assistant_control_data",value:{threadId:e.threadId,messageId:e.messageId}}}},ae={code:"6",name:"data_message",parse:e=>{if(e==null||typeof e!="object"||!("role"in e)||!("data"in e)||typeof e.role!="string"||e.role!=="data")throw new Error('"data_message" parts expect an object with a "role" and "data" property.');return{type:"data_message",value:e}}},Fr=[ee,te,re,se,ae];ee.code+"",te.code+"",re.code+"",se.code+"",ae.code+"";ee.name+"",ee.code,te.name+"",te.code,re.name+"",re.code,se.name+"",se.code,ae.name+"",ae.code;Fr.map(e=>e.code);function Lr({promptTokens:e,completionTokens:t}){return{promptTokens:e,completionTokens:t,totalTokens:e+t}}function jr(e){const t=["ROOT"];let r=-1,s=null;function a(o,n,l){switch(o){case'"':{r=n,t.pop(),t.push(l),t.push("INSIDE_STRING");break}case"f":case"t":case"n":{r=n,s=n,t.pop(),t.push(l),t.push("INSIDE_LITERAL");break}case"-":{t.pop(),t.push(l),t.push("INSIDE_NUMBER");break}case"0":case"1":case"2":case"3":case"4":case"5":case"6":case"7":case"8":case"9":{r=n,t.pop(),t.push(l),t.push("INSIDE_NUMBER");break}case"{":{r=n,t.pop(),t.push(l),t.push("INSIDE_OBJECT_START");break}case"[":{r=n,t.pop(),t.push(l),t.push("INSIDE_ARRAY_START");break}}}function c(o,n){switch(o){case",":{t.pop(),t.push("INSIDE_OBJECT_AFTER_COMMA");break}case"}":{r=n,t.pop();break}}}function f(o,n){switch(o){case",":{t.pop(),t.push("INSIDE_ARRAY_AFTER_COMMA");break}case"]":{r=n,t.pop();break}}}for(let o=0;o<e.length;o++){const n=e[o];switch(t[t.length-1]){case"ROOT":a(n,o,"FINISH");break;case"INSIDE_OBJECT_START":{switch(n){case'"':{t.pop(),t.push("INSIDE_OBJECT_KEY");break}case"}":{r=o,t.pop();break}}break}case"INSIDE_OBJECT_AFTER_COMMA":{switch(n){case'"':{t.pop(),t.push("INSIDE_OBJECT_KEY");break}}break}case"INSIDE_OBJECT_KEY":{switch(n){case'"':{t.pop(),t.push("INSIDE_OBJECT_AFTER_KEY");break}}break}case"INSIDE_OBJECT_AFTER_KEY":{switch(n){case":":{t.pop(),t.push("INSIDE_OBJECT_BEFORE_VALUE");break}}break}case"INSIDE_OBJECT_BEFORE_VALUE":{a(n,o,"INSIDE_OBJECT_AFTER_VALUE");break}case"INSIDE_OBJECT_AFTER_VALUE":{c(n,o);break}case"INSIDE_STRING":{switch(n){case'"':{t.pop(),r=o;break}case"\\":{t.push("INSIDE_STRING_ESCAPE");break}default:r=o}break}case"INSIDE_ARRAY_START":{switch(n){case"]":{r=o,t.pop();break}default:{r=o,a(n,o,"INSIDE_ARRAY_AFTER_VALUE");break}}break}case"INSIDE_ARRAY_AFTER_VALUE":{switch(n){case",":{t.pop(),t.push("INSIDE_ARRAY_AFTER_COMMA");break}case"]":{r=o,t.pop();break}default:{r=o;break}}break}case"INSIDE_ARRAY_AFTER_COMMA":{a(n,o,"INSIDE_ARRAY_AFTER_VALUE");break}case"INSIDE_STRING_ESCAPE":{t.pop(),r=o;break}case"INSIDE_NUMBER":{switch(n){case"0":case"1":case"2":case"3":case"4":case"5":case"6":case"7":case"8":case"9":{r=o;break}case"e":case"E":case"-":case".":break;case",":{t.pop(),t[t.length-1]==="INSIDE_ARRAY_AFTER_VALUE"&&f(n,o),t[t.length-1]==="INSIDE_OBJECT_AFTER_VALUE"&&c(n,o);break}case"}":{t.pop(),t[t.length-1]==="INSIDE_OBJECT_AFTER_VALUE"&&c(n,o);break}case"]":{t.pop(),t[t.length-1]==="INSIDE_ARRAY_AFTER_VALUE"&&f(n,o);break}default:{t.pop();break}}break}case"INSIDE_LITERAL":{const d=e.substring(s,o+1);!"false".startsWith(d)&&!"true".startsWith(d)&&!"null".startsWith(d)?(t.pop(),t[t.length-1]==="INSIDE_OBJECT_AFTER_VALUE"?c(n,o):t[t.length-1]==="INSIDE_ARRAY_AFTER_VALUE"&&f(n,o)):r=o;break}}}let i=e.slice(0,r+1);for(let o=t.length-1;o>=0;o--)switch(t[o]){case"INSIDE_STRING":{i+='"';break}case"INSIDE_OBJECT_KEY":case"INSIDE_OBJECT_AFTER_KEY":case"INSIDE_OBJECT_AFTER_COMMA":case"INSIDE_OBJECT_START":case"INSIDE_OBJECT_BEFORE_VALUE":case"INSIDE_OBJECT_AFTER_VALUE":{i+="}";break}case"INSIDE_ARRAY_START":case"INSIDE_ARRAY_AFTER_COMMA":case"INSIDE_ARRAY_AFTER_VALUE":{i+="]";break}case"INSIDE_LITERAL":{const l=e.substring(s,e.length);"true".startsWith(l)?i+="true".slice(l.length):"false".startsWith(l)?i+="false".slice(l.length):"null".startsWith(l)&&(i+="null".slice(l.length))}}return i}function Jr(e){if(e===void 0)return{value:void 0,state:"undefined-input"};let t=He({text:e});return t.success?{value:t.value,state:"successful-parse"}:(t=He({text:jr(e)}),t.success?{value:t.value,state:"repaired-parse"}:{value:void 0,state:"failed-parse"})}var Vr={code:"0",name:"text",parse:e=>{if(typeof e!="string")throw new Error('"text" parts expect a string value.');return{type:"text",value:e}}},Br={code:"2",name:"data",parse:e=>{if(!Array.isArray(e))throw new Error('"data" parts expect an array value.');return{type:"data",value:e}}},Ur={code:"3",name:"error",parse:e=>{if(typeof e!="string")throw new Error('"error" parts expect a string value.');return{type:"error",value:e}}},Yr={code:"8",name:"message_annotations",parse:e=>{if(!Array.isArray(e))throw new Error('"message_annotations" parts expect an array value.');return{type:"message_annotations",value:e}}},Kr={code:"9",name:"tool_call",parse:e=>{if(e==null||typeof e!="object"||!("toolCallId"in e)||typeof e.toolCallId!="string"||!("toolName"in e)||typeof e.toolName!="string"||!("args"in e)||typeof e.args!="object")throw new Error('"tool_call" parts expect an object with a "toolCallId", "toolName", and "args" property.');return{type:"tool_call",value:e}}},$r={code:"a",name:"tool_result",parse:e=>{if(e==null||typeof e!="object"||!("toolCallId"in e)||typeof e.toolCallId!="string"||!("result"in e))throw new Error('"tool_result" parts expect an object with a "toolCallId" and a "result" property.');return{type:"tool_result",value:e}}},zr={code:"b",name:"tool_call_streaming_start",parse:e=>{if(e==null||typeof e!="object"||!("toolCallId"in e)||typeof e.toolCallId!="string"||!("toolName"in e)||typeof e.toolName!="string")throw new Error('"tool_call_streaming_start" parts expect an object with a "toolCallId" and "toolName" property.');return{type:"tool_call_streaming_start",value:e}}},Gr={code:"c",name:"tool_call_delta",parse:e=>{if(e==null||typeof e!="object"||!("toolCallId"in e)||typeof e.toolCallId!="string"||!("argsTextDelta"in e)||typeof e.argsTextDelta!="string")throw new Error('"tool_call_delta" parts expect an object with a "toolCallId" and "argsTextDelta" property.');return{type:"tool_call_delta",value:e}}},qr={code:"d",name:"finish_message",parse:e=>{if(e==null||typeof e!="object"||!("finishReason"in e)||typeof e.finishReason!="string")throw new Error('"finish_message" parts expect an object with a "finishReason" property.');const t={finishReason:e.finishReason};return"usage"in e&&e.usage!=null&&typeof e.usage=="object"&&"promptTokens"in e.usage&&"completionTokens"in e.usage&&(t.usage={promptTokens:typeof e.usage.promptTokens=="number"?e.usage.promptTokens:Number.NaN,completionTokens:typeof e.usage.completionTokens=="number"?e.usage.completionTokens:Number.NaN}),{type:"finish_message",value:t}}},Hr={code:"e",name:"finish_step",parse:e=>{if(e==null||typeof e!="object"||!("finishReason"in e)||typeof e.finishReason!="string")throw new Error('"finish_step" parts expect an object with a "finishReason" property.');const t={finishReason:e.finishReason,isContinued:!1};return"usage"in e&&e.usage!=null&&typeof e.usage=="object"&&"promptTokens"in e.usage&&"completionTokens"in e.usage&&(t.usage={promptTokens:typeof e.usage.promptTokens=="number"?e.usage.promptTokens:Number.NaN,completionTokens:typeof e.usage.completionTokens=="number"?e.usage.completionTokens:Number.NaN}),"isContinued"in e&&typeof e.isContinued=="boolean"&&(t.isContinued=e.isContinued),{type:"finish_step",value:t}}},Wr={code:"f",name:"start_step",parse:e=>{if(e==null||typeof e!="object"||!("messageId"in e)||typeof e.messageId!="string")throw new Error('"start_step" parts expect an object with an "id" property.');return{type:"start_step",value:{messageId:e.messageId}}}},Xr={code:"g",name:"reasoning",parse:e=>{if(typeof e!="string")throw new Error('"reasoning" parts expect a string value.');return{type:"reasoning",value:e}}},Zr={code:"h",name:"source",parse:e=>{if(e==null||typeof e!="object")throw new Error('"source" parts expect a Source object.');return{type:"source",value:e}}},Qr={code:"i",name:"redacted_reasoning",parse:e=>{if(e==null||typeof e!="object"||!("data"in e)||typeof e.data!="string")throw new Error('"redacted_reasoning" parts expect an object with a "data" property.');return{type:"redacted_reasoning",value:{data:e.data}}}},es={code:"j",name:"reasoning_signature",parse:e=>{if(e==null||typeof e!="object"||!("signature"in e)||typeof e.signature!="string")throw new Error('"reasoning_signature" parts expect an object with a "signature" property.');return{type:"reasoning_signature",value:{signature:e.signature}}}},ts={code:"k",name:"file",parse:e=>{if(e==null||typeof e!="object"||!("data"in e)||typeof e.data!="string"||!("mimeType"in e)||typeof e.mimeType!="string")throw new Error('"file" parts expect an object with a "data" and "mimeType" property.');return{type:"file",value:e}}},De=[Vr,Br,Ur,Yr,Kr,$r,zr,Gr,qr,Hr,Wr,Xr,Zr,Qr,es,ts],rs=Object.fromEntries(De.map(e=>[e.code,e]));Object.fromEntries(De.map(e=>[e.name,e.code]));var ss=De.map(e=>e.code),as=e=>{const t=e.indexOf(":");if(t===-1)throw new Error("Failed to parse stream string. No separator found.");const r=e.slice(0,t);if(!ss.includes(r))throw new Error(`Failed to parse stream string. Invalid code ${r}.`);const s=r,a=e.slice(t+1),c=JSON.parse(a);return rs[s].parse(c)},ns=10;function os(e,t){const r=new Uint8Array(t);let s=0;for(const a of e)r.set(a,s),s+=a.length;return e.length=0,r}async function is({stream:e,onTextPart:t,onReasoningPart:r,onReasoningSignaturePart:s,onRedactedReasoningPart:a,onSourcePart:c,onFilePart:f,onDataPart:i,onErrorPart:o,onToolCallStreamingStartPart:n,onToolCallDeltaPart:l,onToolCallPart:d,onToolResultPart:h,onMessageAnnotationsPart:g,onFinishMessagePart:m,onFinishStepPart:b,onStartStepPart:S}){const y=e.getReader(),v=new TextDecoder,k=[];let N=0;for(;;){const{value:w}=await y.read();if(w&&(k.push(w),N+=w.length,w[w.length-1]!==ns))continue;if(k.length===0)break;const p=os(k,N);N=0;const E=v.decode(p,{stream:!0}).split(`
`).filter(T=>T!=="").map(as);for(const{type:T,value:I}of E)switch(T){case"text":await(t==null?void 0:t(I));break;case"reasoning":await(r==null?void 0:r(I));break;case"reasoning_signature":await(s==null?void 0:s(I));break;case"redacted_reasoning":await(a==null?void 0:a(I));break;case"file":await(f==null?void 0:f(I));break;case"source":await(c==null?void 0:c(I));break;case"data":await(i==null?void 0:i(I));break;case"error":await(o==null?void 0:o(I));break;case"message_annotations":await(g==null?void 0:g(I));break;case"tool_call_streaming_start":await(n==null?void 0:n(I));break;case"tool_call_delta":await(l==null?void 0:l(I));break;case"tool_call":await(d==null?void 0:d(I));break;case"tool_result":await(h==null?void 0:h(I));break;case"finish_message":await(m==null?void 0:m(I));break;case"finish_step":await(b==null?void 0:b(I));break;case"start_step":await(S==null?void 0:S(I));break;default:{const W=T;throw new Error(`Unknown stream part type: ${W}`)}}}}async function ls({stream:e,update:t,onToolCall:r,onFinish:s,generateId:a=Re,getCurrentDate:c=()=>new Date,lastMessage:f}){var i,o;const n=(f==null?void 0:f.role)==="assistant";let l=n?1+((o=(i=f.toolInvocations)==null?void 0:i.reduce((p,E)=>{var T;return Math.max(p,(T=E.step)!=null?T:0)},0))!=null?o:0):0;const d=n?structuredClone(f):{id:a(),createdAt:c(),role:"assistant",content:"",parts:[]};let h,g,m;function b(p,E){const T=d.parts.find(I=>I.type==="tool-invocation"&&I.toolInvocation.toolCallId===p);T!=null?T.toolInvocation=E:d.parts.push({type:"tool-invocation",toolInvocation:E})}const S=[];let y=n?f==null?void 0:f.annotations:void 0;const v={};let k={completionTokens:NaN,promptTokens:NaN,totalTokens:NaN},N="unknown";function w(){const p=[...S];y!=null&&y.length&&(d.annotations=y);const E={...structuredClone(d),revisionId:a()};t({message:E,data:p,replaceLastMessage:n})}await is({stream:e,onTextPart(p){h==null?(h={type:"text",text:p},d.parts.push(h)):h.text+=p,d.content+=p,w()},onReasoningPart(p){var E;m==null?(m={type:"text",text:p},g!=null&&g.details.push(m)):m.text+=p,g==null?(g={type:"reasoning",reasoning:p,details:[m]},d.parts.push(g)):g.reasoning+=p,d.reasoning=((E=d.reasoning)!=null?E:"")+p,w()},onReasoningSignaturePart(p){m!=null&&(m.signature=p.signature)},onRedactedReasoningPart(p){g==null&&(g={type:"reasoning",reasoning:"",details:[]},d.parts.push(g)),g.details.push({type:"redacted",data:p.data}),m=void 0,w()},onFilePart(p){d.parts.push({type:"file",mimeType:p.mimeType,data:p.data}),w()},onSourcePart(p){d.parts.push({type:"source",source:p}),w()},onToolCallStreamingStartPart(p){d.toolInvocations==null&&(d.toolInvocations=[]),v[p.toolCallId]={text:"",step:l,toolName:p.toolName,index:d.toolInvocations.length};const E={state:"partial-call",step:l,toolCallId:p.toolCallId,toolName:p.toolName,args:void 0};d.toolInvocations.push(E),b(p.toolCallId,E),w()},onToolCallDeltaPart(p){const E=v[p.toolCallId];E.text+=p.argsTextDelta;const{value:T}=Jr(E.text),I={state:"partial-call",step:E.step,toolCallId:p.toolCallId,toolName:E.toolName,args:T};d.toolInvocations[E.index]=I,b(p.toolCallId,I),w()},async onToolCallPart(p){const E={state:"call",step:l,...p};if(v[p.toolCallId]!=null?d.toolInvocations[v[p.toolCallId].index]=E:(d.toolInvocations==null&&(d.toolInvocations=[]),d.toolInvocations.push(E)),b(p.toolCallId,E),w(),r){const T=await r({toolCall:p});if(T!=null){const I={state:"result",step:l,...p,result:T};d.toolInvocations[d.toolInvocations.length-1]=I,b(p.toolCallId,I),w()}}},onToolResultPart(p){const E=d.toolInvocations;if(E==null)throw new Error("tool_result must be preceded by a tool_call");const T=E.findIndex(W=>W.toolCallId===p.toolCallId);if(T===-1)throw new Error("tool_result must be preceded by a tool_call with the same toolCallId");const I={...E[T],state:"result",...p};E[T]=I,b(p.toolCallId,I),w()},onDataPart(p){S.push(...p),w()},onMessageAnnotationsPart(p){y==null?y=[...p]:y.push(...p),w()},onFinishStepPart(p){l+=1,h=p.isContinued?h:void 0,g=void 0,m=void 0},onStartStepPart(p){n||(d.id=p.messageId),d.parts.push({type:"step-start"}),w()},onFinishMessagePart(p){N=p.finishReason,p.usage!=null&&(k=Lr(p.usage))},onErrorPart(p){throw new Error(p)}}),s==null||s({message:d,finishReason:N,usage:k})}async function cs({stream:e,onTextPart:t}){const r=e.pipeThrough(new TextDecoderStream).getReader();for(;;){const{done:s,value:a}=await r.read();if(s)break;await t(a)}}async function us({stream:e,update:t,onFinish:r,getCurrentDate:s=()=>new Date,generateId:a=Re}){const c={type:"text",text:""},f={id:a(),createdAt:s(),role:"assistant",content:"",parts:[c]};await cs({stream:e,onTextPart:i=>{f.content+=i,c.text+=i,t({message:{...f},data:[],replaceLastMessage:!1})}}),r==null||r(f,{usage:{completionTokens:NaN,promptTokens:NaN,totalTokens:NaN},finishReason:"unknown"})}var fs=()=>fetch;async function ds({api:e,body:t,streamProtocol:r="data",credentials:s,headers:a,abortController:c,restoreMessagesOnFailure:f,onResponse:i,onUpdate:o,onFinish:n,onToolCall:l,generateId:d,fetch:h=fs(),lastMessage:g}){var m,b;const S=await h(e,{method:"POST",body:JSON.stringify(t),headers:{"Content-Type":"application/json",...a},signal:(m=c==null?void 0:c())==null?void 0:m.signal,credentials:s}).catch(y=>{throw y});if(i)try{await i(S)}catch(y){throw y}if(!S.ok)throw new Error((b=await S.text())!=null?b:"Failed to fetch the chat response.");if(!S.body)throw new Error("The response body is empty.");switch(r){case"text":{await us({stream:S.body,update:o,onFinish:n,generateId:d});return}case"data":{await ls({stream:S.body,update:o,lastMessage:g,onToolCall:l,onFinish({message:y,finishReason:v,usage:k}){n&&y!=null&&n(y,{usage:k,finishReason:v})},generateId:d});return}default:{const y=r;throw new Error(`Unknown stream protocol: ${y}`)}}}function xe(e){return e==null?void 0:e.reduce((t,r)=>{var s;return Math.max(t,(s=r.step)!=null?s:0)},0)}function mt(e){var t;return(t=e.parts)!=null?t:[...e.toolInvocations?e.toolInvocations.map(r=>({type:"tool-invocation",toolInvocation:r})):[],...e.reasoning?[{type:"reasoning",reasoning:e.reasoning,details:[{type:"text",text:e.reasoning}]}]:[],...e.content?[{type:"text",text:e.content}]:[]]}function We(e){return e.map(t=>({...t,parts:mt(t)}))}async function Xe(e){if(!e)return[];if(e instanceof FileList)return Promise.all(Array.from(e).map(async t=>{const{name:r,type:s}=t,a=await new Promise((c,f)=>{const i=new FileReader;i.onload=o=>{var n;c((n=o.target)==null?void 0:n.result)},i.onerror=o=>f(o),i.readAsDataURL(t)});return{name:r,contentType:s,url:a}}));if(Array.isArray(e))return e;throw new Error("Invalid attachments type")}function ps({originalMaxToolInvocationStep:e,originalMessageCount:t,maxSteps:r,messages:s}){var a;const c=s[s.length-1];return r>1&&c!=null&&(s.length>t||xe(c.toolInvocations)!==e)&&yt(c)&&((a=xe(c.toolInvocations))!=null?a:0)<r}function yt(e){if(e.role!=="assistant")return!1;const t=e.parts.reduce((s,a,c)=>a.type==="step-start"?c:s,-1),r=e.parts.slice(t+1).filter(s=>s.type==="tool-invocation");return r.length>0&&r.every(s=>"result"in s.toolInvocation)}function hs({messages:e,toolCallId:t,toolResult:r}){var s;const a=e[e.length-1],c=a.parts.find(i=>i.type==="tool-invocation"&&i.toolInvocation.toolCallId===t);if(c==null)return;const f={...c.toolInvocation,state:"result",result:r};c.toolInvocation=f,a.toolInvocations=(s=a.toolInvocations)==null?void 0:s.map(i=>i.toolCallId===t?f:i)}var D,O,P,G,ge;const Oe=class Oe extends Map{constructor(r){super();A(this,G);A(this,D,new Map);A(this,O,F(0));A(this,P,F(0));if(r){for(var[s,a]of r)super.set(s,a);u(this,P).v=super.size}}has(r){var s=u(this,D),a=s.get(r);if(a===void 0){var c=super.get(r);if(c!==void 0)a=F(0),s.set(r,a);else return _(u(this,O)),!1}return _(a),!0}forEach(r,s){de(this,G,ge).call(this),super.forEach(r,s)}get(r){var s=u(this,D),a=s.get(r);if(a===void 0){var c=super.get(r);if(c!==void 0)a=F(0),s.set(r,a);else{_(u(this,O));return}}return _(a),super.get(r)}set(r,s){var d;var a=u(this,D),c=a.get(r),f=super.get(r),i=super.set(r,s),o=u(this,O);if(c===void 0)a.set(r,F(0)),R(u(this,P),super.size),Q(o);else if(f!==s){Q(c);var n=o.reactions===null?null:new Set(o.reactions),l=n===null||!((d=c.reactions)!=null&&d.every(h=>n.has(h)));l&&Q(o)}return i}delete(r){var s=u(this,D),a=s.get(r),c=super.delete(r);return a!==void 0&&(s.delete(r),R(u(this,P),super.size),R(a,-1),Q(u(this,O))),c}clear(){if(super.size!==0){super.clear();var r=u(this,D);R(u(this,P),0);for(var s of r.values())R(s,-1);Q(u(this,O)),r.clear()}}keys(){return _(u(this,O)),super.keys()}values(){return de(this,G,ge).call(this),super.values()}entries(){return de(this,G,ge).call(this),super.entries()}[Symbol.iterator](){return this.entries()}get size(){return _(u(this,P)),super.size}};D=new WeakMap,O=new WeakMap,P=new WeakMap,G=new WeakSet,ge=function(){_(u(this,O));var r=u(this,D);if(u(this,P).v!==r.size)for(var s of Pe(Oe.prototype,this,"keys").call(this))r.has(s)||r.set(s,F(0));for(var[,a]of u(this,D))_(a)};let Ce=Oe;function gs(e){const t=Symbol(e);return{hasContext:()=>{var r;try{return Xt(t)}catch(s){if(typeof s=="object"&&s!==null&&"message"in s&&typeof s.message=="string"&&((r=s.message)!=null&&r.includes("lifecycle_outside_component")))return!1;throw s}},getContext:()=>Wt(t),setContext:r=>Ht(t,r)}}var ne;class _s extends Ce{constructor(r,s){super(s);A(this,ne);K(this,ne,r)}get(r){return super.get(r)??Ne(()=>this.set(r,new(u(this,ne)))).get(r)}}ne=new WeakMap;var oe,ie,le,ce;class ms{constructor(){A(this,oe,z(Zt([])));A(this,ie,z());A(this,le,z("ready"));A(this,ce,z())}get messages(){return _(u(this,oe))}set messages(t){R(u(this,oe),t,!0)}get data(){return _(u(this,ie))}set data(t){R(u(this,ie),t,!0)}get status(){return _(u(this,le))}set status(t){R(u(this,le),t,!0)}get error(){return _(u(this,ce))}set error(t){R(u(this,ce),t,!0)}}oe=new WeakMap,ie=new WeakMap,le=new WeakMap,ce=new WeakMap;class ys extends _s{constructor(t){super(ms,t)}}const{hasContext:Es,getContext:Is}=gs("Chat");var x,_e,B,me,ye,q,ue,C,U,fe,j;class bs{constructor(t={}){A(this,x,{});A(this,_e,$(()=>u(this,x).api??"/api/chat"));A(this,B,$(()=>u(this,x).generateId??Re));A(this,me,$(()=>u(this,x).maxSteps??1));A(this,ye,$(()=>u(this,x).streamProtocol??"data"));A(this,q,z());A(this,ue,$(()=>u(this,x).id??_(u(this,B))()));A(this,C,$(()=>_(u(this,q)).get(this.id)));A(this,U);A(this,fe,z());Y(this,"append",async(t,{data:r,headers:s,body:a,experimental_attachments:c}={})=>{const f=await Xe(c),i=this.messages.concat({...t,id:t.id??_(u(this,B))(),createdAt:t.createdAt??new Date,experimental_attachments:f.length>0?f:void 0,parts:mt(t)});return u(this,j).call(this,{messages:i,headers:s,body:a,data:r})});Y(this,"reload",async({data:t,headers:r,body:s}={})=>{if(this.messages.length===0)return;const a=this.messages[this.messages.length-1];await u(this,j).call(this,{messages:a.role==="assistant"?this.messages.slice(0,-1):this.messages,headers:r,body:s,data:t})});Y(this,"stop",()=>{var t;try{(t=u(this,U))==null||t.abort()}catch{}finally{_(u(this,C)).status="ready",K(this,U,void 0)}});Y(this,"handleSubmit",async(t,r={})=>{var i;if((i=t==null?void 0:t.preventDefault)==null||i.call(t),!this.input&&!r.allowEmptySubmit)return;const s=await Xe(r.experimental_attachments),c={messages:this.messages.concat({id:_(u(this,B))(),createdAt:new Date,role:"user",content:this.input,experimental_attachments:s.length>0?s:void 0,parts:[{type:"text",text:this.input}]}),headers:r.headers,body:r.body,data:r.data},f=u(this,j).call(this,c);this.input="",await f});Y(this,"addToolResult",async({toolCallId:t,result:r})=>{if(hs({messages:this.messages,toolCallId:t,toolResult:r}),_(u(this,C)).status==="submitted"||_(u(this,C)).status==="streaming")return;const s=this.messages[this.messages.length-1];yt(s)&&await u(this,j).call(this,{messages:this.messages})});A(this,j,async t=>{var c;_(u(this,C)).status="submitted",_(u(this,C)).error=void 0;const r=We(t.messages),s=r.length,a=xe((c=r[r.length-1])==null?void 0:c.toolInvocations);try{const f=new AbortController;K(this,U,f),this.messages=r;const i=u(this,x).sendExtraMessageFields?r:r.map(({role:n,content:l,experimental_attachments:d,data:h,annotations:g,toolInvocations:m,parts:b})=>({role:n,content:l,...d!==void 0&&{experimental_attachments:d},...h!==void 0&&{data:h},...g!==void 0&&{annotations:g},...m!==void 0&&{toolInvocations:m},...b!==void 0&&{parts:b}})),o=this.data??[];await ds({api:_(u(this,_e)),body:{id:this.id,messages:i,data:t.data,...Be(u(this,x).body),...t.body},streamProtocol:_(u(this,ye)),credentials:u(this,x).credentials,headers:{...u(this,x).headers,...t.headers},abortController:()=>f,restoreMessagesOnFailure:()=>{},onResponse:u(this,x).onResponse,onUpdate:({message:n,data:l,replaceLastMessage:d})=>{_(u(this,C)).status="streaming",this.messages=r,d?this.messages[this.messages.length-1]=n:this.messages.push(n),l!=null&&l.length&&(this.data=o,this.data.push(...l))},onToolCall:u(this,x).onToolCall,onFinish:u(this,x).onFinish,generateId:_(u(this,B)),fetch:u(this,x).fetch,lastMessage:Be(this.messages[this.messages.length-1])}),K(this,U,void 0),_(u(this,C)).status="ready"}catch(f){if(Nr(f))return;const i=f instanceof Error?f:new Error(String(f));u(this,x).onError&&u(this,x).onError(i),_(u(this,C)).status="error",_(u(this,C)).error=i}ps({originalMaxToolInvocationStep:a,originalMessageCount:s,maxSteps:_(u(this,me)),messages:this.messages})&&await u(this,j).call(this,{messages:this.messages})});Es()?R(u(this,q),Is(),!0):R(u(this,q),new ys,!0),K(this,x,t),this.messages=t.initialMessages??[],this.input=t.initialInput??""}get id(){return _(u(this,ue))}set id(t){R(u(this,ue),t)}get data(){return _(u(this,C)).data}set data(t){_(u(this,C)).data=t}get status(){return _(u(this,C)).status}get error(){return _(u(this,C)).error}get input(){return _(u(this,fe))}set input(t){R(u(this,fe),t,!0)}get messages(){return _(u(this,C)).messages}set messages(t){Ne(()=>_(u(this,C)).messages=We(t))}}x=new WeakMap,_e=new WeakMap,B=new WeakMap,me=new WeakMap,ye=new WeakMap,q=new WeakMap,ue=new WeakMap,C=new WeakMap,U=new WeakMap,fe=new WeakMap,j=new WeakMap;var ws=ke("<div> </div>"),vs=ke("<li><div> </div> <div></div></li>"),Ss=ke('<main><ul></ul> <form><input> <button type="submit">Send</button></form></main>');function Rs(e,t){Qt(t,!1);const r=rt(new bs);St();var s=Ss(),a=Z(s);Ye(a,5,()=>_(r).messages,Ue,(i,o)=>{var n=vs(),l=Z(n),d=Z(l,!0);J(l);var h=je(l,2);Ye(h,5,()=>_(o).parts,Ue,(g,m)=>{var b=vt(),S=sr(b);{var y=v=>{var k=ws(),N=Z(k,!0);J(k),Je(()=>Ve(N,_(m).text)),pe(v,k)};ir(S,v=>{_(m).type==="text"&&v(y)})}pe(g,b)}),J(h),J(n),Je(()=>Ve(d,_(o).role)),pe(i,n)}),J(a);var c=je(a,2),f=Z(c);hr(f),tr(2),J(c),J(s),or("submit",c,function(...i){var o;(o=_(r).handleSubmit)==null||o.apply(this,i)}),_r(f,()=>_(r).input,i=>rr(r,_(r).input=i)),pe(e,s),er()}export{Rs as component};
